<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Bataille navale</title>
    <style>
    #tableau-J0, #tableau-J1{
      width: 50%;
      margin: 10px 25%;
    }
    .ligne{
      display: flex;
      justify-content: flex-start;
    }
    .ligne.desactived{
      opacity: 0.5;
    }
    .case{
      height: 30px;
      width: 30px;
      background-color: #efefef;
      border: solid #adadad 1px;
      margin-right: 1px;
      margin-bottom: 1px;
      cursor: pointer;
    }
    .case.touche, .case.touche:hover{
      background-color: red;
    }
    .case.coule, .case.coule:hover{
      background-color: green;
    }
    .case.clique{
      background-color: #aeaeae;
    }
    .case:hover{
      background-color: #dedede;
    }
    .case.brown{
      background-color: brown;
    }
    .case.pink{
      background-color: pink;
    }
    .case.yellow{
      background-color: yellow;
    }
    .case.black{
      background-color: black;
    }
    .case.cyan{
      background-color: cyan;
    }
    </style>
    <script src="jquery-3.1.1.min.js"></script>
  </head>
  <body>
    <h1>Jeu de la Bataille Navale</h1>

    <div id="tableau-J0">

    </div>

    <div id="tableau-J1">

    </div>

  </body>

  <script>
    var joueurs = new Array({'nom':"Dimitri"}, {'nom':"Ordinateur"});
    var jeu = new Array({"joueur":joueurs[0], "grille":new Array()},{"joueur":joueurs[1],"grille":new Array()});
    var list_orientations = new Array('Horizontal','Vertical');
    var bateaux = new Array(
        {
            'nom' : 'Porte-avion',
            'longueur' : 5,
            'restant' : new Array(5,5),
            'etat' : new Array("",""),
            'couleur' : 'brown'
        },
        {
            'nom' : 'Croiseur',
            'longueur' : 4,
            'restant' : new Array(4,4),
            'etat' : new Array("",""),
            'couleur' : 'cyan'
        },
        {
            'nom' : 'Contre-torpilleurs',
            'longueur' : 3,
            'restant' : new Array(3,3),
            'etat' : new Array("",""),
            'couleur' : 'black'
        },
        {
            'nom' : 'Sous-marin',
            'longueur' : 3,
            'restant' : new Array(3,3),
            'etat' : new Array("",""),
            'couleur' : 'yellow'
        },
        {
            'nom' : 'Torpilleur',
            'longueur' : 2,
            'restant' : new Array(2,2),
            'etat' : new Array("",""),
            'couleur' : 'pink'
        }
    );

    var currentJ = 0;

    //var nb_case = prompt("Entrer le nombre de case (< 20)");
    var nb_cases = 10;

    if(nb_cases > 20){
      alert('Le nombre de case doit être inférieur à 20');
      $('#tableau').html('Veuillez recharger la page');
    }else{
      for(J=0; J<2; J++){
        initialisationGrille();
        for(var B=0; B< ((bateaux.length)-1); B++){
          bateauHasard(B);
        }
        constructionCssGrille();
        changeUser();
      }
      changeUser();
    }

    $(document).on('click', '.case', function(){
      var data_x = $(this).attr('data-x');
      var data_y = $(this).attr('data-y');
      if(verifTouche(data_x, data_y)){
          changeUser();
      }
    });

    function changeUser(){
      if(currentJ == 0){
        currentJ = 1;
        $('#tableau-J0 .ligne').addClass('desactived');
        $('#tableau-J1 .ligne').removeClass('desactived');
      }else{
        currentJ = 0;
        $('#tableau-J0 .ligne').removeClass('desactived');
        $('#tableau-J1 .ligne').addClass('desactived');
      }

    }

    function initialisationGrille(){
      for(var i=1; i<=nb_cases; i++){
        jeu[currentJ].grille[i] = new Array();
        for(var j=1; j<=nb_cases; j++){
          jeu[currentJ].grille[i][j] = new Object({'etat':null, 'bateau':null});
        }
      }
    }

    function verifTouche(x,y){
      console.log(jeu[currentJ].grille[x][y]);
      if(jeu[currentJ].grille[x][y].etat == "bateau"){
        jeu[currentJ].grille[x][y].bateau.restant[currentJ]--;
        jeu[currentJ].grille[x][y].etat = "T";
        if(jeu[currentJ].grille[x][y].bateau.restant[currentJ] == 0){
          jeu[currentJ].grille[x][y].bateau.etat[currentJ] = "coule";
          jeu[currentJ].grille[x][y].etat = "";
          console.log('coulé !');
        }else{
          jeu[currentJ].grille[x][y].etat = "touche";
          jeu[currentJ].grille[x][y].etat = "clique";
        }
      }else if(jeu[currentJ].grille[x][y].etat == "T" || jeu[currentJ].grille[x][y].etat == "X"){
        alert("déjà touché !");
        return false;
      }else{
        console.log("raté");
        jeu[currentJ].grille[x][y].etat = "clique";
      }
      // On reconstruit le tableau en HTML CSS
      constructionCssGrille();
      return true;
    }

    function constructionCssGrille(){
      var tableau_html = "";
      for(var i=1; i<=nb_cases; i++){
        tableau_html += '<div class="ligne">';
        for(var j=1; j<=nb_cases; j++){
          if(jeu[currentJ].grille[i][j].bateau){
            tableau_html += '<div class="case '+jeu[currentJ].grille[i][j].bateau.etat[currentJ]+' '+jeu[currentJ].grille[i][j].etat+'" style="border-color: '+jeu[currentJ].grille[i][j].bateau.couleur+'" data-x="'+i+'" data-y="'+j+'"></div>';
          }else{
            tableau_html += '<div class="case" data-x="'+i+'" data-y="'+j+'"></div>';
          }
        }
        tableau_html += '</div>';
      }
      console.log("J = " +currentJ);
      $('#tableau-J'+currentJ).html(tableau_html);
    }

    function bateauHasard(id_bateau){
      console.log("id bateau : "+id_bateau)
      // Nombre au hasard entre 1 et longueur max de la grille
      var case_depart_i = Math.floor((Math.random() * nb_cases) + 1);
      var case_depart_j = Math.floor((Math.random() * nb_cases) + 1);
      var orientation = Math.floor((Math.random() * 2));
      orientation = list_orientations[orientation];
      console.log("ORIENTATION : " + orientation)
      if(jeu[currentJ].grille[case_depart_i][case_depart_j].bateau){
        if(jeu[currentJ].grille[case_depart_i][case_depart_j].etat == "bateau")
          bateauHasard(id_bateau);
      }else{
        if(orientation == 'Horizontal'){
          console.log("CASE DEPART : " +case_depart_j);
          if(case_depart_j > (nb_cases/2)){
            bateauHasard(id_bateau);
          }else{
            for (var j = case_depart_j; j < (case_depart_j+bateaux[id_bateau].longueur); j++){
                jeu[currentJ].grille[case_depart_i][j].bateau = bateaux[id_bateau];
                jeu[currentJ].grille[case_depart_i][j].etat = "bateau"
            }
          }
        }else if(orientation == 'Vertical'){
          //console.log("CASE DEPART : " +case_depart_i);
          if(case_depart_i > (nb_cases/2)){
            bateauHasard(id_bateau);
          }else{
            for (var i = case_depart_i; i < (case_depart_i+bateaux[id_bateau].longueur); i++){
                jeu[currentJ].grille[i][case_depart_j].bateau = bateaux[id_bateau];
                jeu[currentJ].grille[i][case_depart_j].etat = "bateau"
            }
          }
        }
      }
    }

  </script>

</html>
